// This is your Prisma schema file for PostgreSQL
// Database: Accounting, Users, Roles, Financial Data

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER MANAGEMENT & AUTHENTICATION
// ============================================

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  password      String
  firstName     String
  lastName      String
  phone         String?
  avatar        String?
  isActive      Boolean   @default(true)
  emailVerified Boolean   @default(false)
  lastLoginAt   DateTime?
  
  // Relations
  roleId        String
  role          Role      @relation(fields: [roleId], references: [id])
  departmentId  String?
  department    Department? @relation(fields: [departmentId], references: [id])
  
  // Timestamps
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Audit trails
  createdJournalEntries JournalEntry[] @relation("CreatedBy")
  createdInvoices       Invoice[]      @relation("CreatedBy")
  createdPayments       Payment[]      @relation("CreatedBy")
  createdTenders        Tender[]       @relation("TenderCreatedBy")
  evaluatedTenders      TenderEvaluation[] @relation("TenderEvaluatedBy")
  
  @@index([email])
  @@index([roleId])
  @@map("users")
}

model Role {
  id          String   @id @default(uuid())
  name        String   @unique
  nameAr      String
  description String?
  permissions Json     // Flexible permissions structure
  isActive    Boolean  @default(true)
  
  users       User[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("roles")
}

model Department {
  id          String   @id @default(uuid())
  code        String   @unique
  name        String
  nameAr      String
  description String?
  parentId    String?
  parent      Department?  @relation("DepartmentHierarchy", fields: [parentId], references: [id])
  children    Department[] @relation("DepartmentHierarchy")
  isActive    Boolean  @default(true)
  
  users       User[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([parentId])
  @@map("departments")
}

// ============================================
// ACCOUNTING - CHART OF ACCOUNTS
// ============================================

enum AccountType {
  ASSET           // أصول
  LIABILITY       // خصوم
  EQUITY          // حقوق ملكية
  REVENUE         // إيرادات
  EXPENSE         // مصروفات
  COST_OF_SALES   // تكلفة المبيعات
}

model Account {
  id              String      @id @default(uuid())
  code            String      @unique  // Account code (e.g., 1010001)
  name            String      // English name
  nameAr          String      // Arabic name
  type            AccountType
  parentId        String?
  parent          Account?    @relation("AccountHierarchy", fields: [parentId], references: [id])
  children        Account[]   @relation("AccountHierarchy")
  
  // Account properties
  level           Int         // Hierarchy level (1, 2, 3, 4...)
  isActive        Boolean     @default(true)
  allowPosting    Boolean     @default(true)  // Can post transactions
  currency        String      @default("EGP")
  description     String?
  
  // Balance tracking
  debitBalance    Decimal     @default(0)
  creditBalance   Decimal     @default(0)
  
  // Relations
  journalEntryLines JournalEntryLine[]
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  @@index([code])
  @@index([type])
  @@index([parentId])
  @@map("accounts")
}

// ============================================
// JOURNAL ENTRIES & TRANSACTIONS
// ============================================

enum JournalEntryStatus {
  DRAFT
  POSTED
  CANCELLED
}

model JournalEntry {
  id              String             @id @default(uuid())
  entryNumber     String             @unique  // JE-2024-0001
  date            DateTime
  description     String
  descriptionAr   String?
  status          JournalEntryStatus @default(DRAFT)
  reference       String?            // Reference to source document
  notes           String?
  
  // Relations
  lines           JournalEntryLine[]
  
  // Audit
  createdById     String
  createdBy       User               @relation("CreatedBy", fields: [createdById], references: [id])
  postedAt        DateTime?
  
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  
  @@index([entryNumber])
  @@index([date])
  @@index([status])
  @@map("journal_entries")
}

model JournalEntryLine {
  id              String        @id @default(uuid())
  
  journalEntryId  String
  journalEntry    JournalEntry  @relation(fields: [journalEntryId], references: [id], onDelete: Cascade)
  
  accountId       String
  account         Account       @relation(fields: [accountId], references: [id])
  
  debit           Decimal       @default(0)
  credit          Decimal       @default(0)
  description     String?
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@index([journalEntryId])
  @@index([accountId])
  @@map("journal_entry_lines")
}

// ============================================
// CUSTOMERS & VENDORS (SUPPLIERS)
// ============================================

model Customer {
  id              String    @id @default(uuid())
  code            String    @unique
  name            String
  nameAr          String
  type            String    // INDIVIDUAL, COMPANY, GOVERNMENT
  
  // Contact Information
  email           String?
  phone           String?
  mobile          String?
  website         String?
  
  // Address
  address         String?
  city            String?
  governorate     String?
  country         String    @default("Egypt")
  postalCode      String?
  
  // Business Information
  taxNumber       String?   @unique
  commercialRegNo String?
  
  // Financial
  creditLimit     Decimal   @default(0)
  balance         Decimal   @default(0)
  
  // Relations
  invoices        Invoice[]
  payments        Payment[]
  workOrders      WorkOrder[]
  
  isActive        Boolean   @default(true)
  notes           String?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([code])
  @@index([taxNumber])
  @@map("customers")
}

model Vendor {
  id              String    @id @default(uuid())
  code            String    @unique
  name            String
  nameAr          String
  type            String    // VEHICLE_OWNER, SUPPLIER, SERVICE_PROVIDER
  
  // Contact Information
  email           String?
  phone           String?
  mobile          String?
  contactPerson   String?
  
  // Address
  address         String?
  city            String?
  governorate     String?
  country         String    @default("Egypt")
  
  // Business Information
  taxNumber       String?   @unique
  commercialRegNo String?
  
  // Vehicle Owner Specific (if type = VEHICLE_OWNER)
  licenseNumber   String?
  licenseExpiry   DateTime?
  
  // Financial
  balance         Decimal   @default(0)
  
  // Relations
  vehicles        Vehicle[]
  bills           Bill[]
  payments        Payment[]
  documentPurchases DocumentPurchase[]
  bids            Bid[]
  workOrders      WorkOrder[]
  
  isActive        Boolean   @default(true)
  notes           String?
  rating          Decimal?   // 0.00 to 5.00
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([code])
  @@index([type])
  @@index([taxNumber])
  @@map("vendors")
}

// ============================================
// VEHICLES (EXTERNAL FLEET)
// ============================================

enum VehicleType {
  TRUCK
  TRAILER
  REFRIGERATED
  CONTAINER
  TANKER
}

enum VehicleStatus {
  AVAILABLE
  ASSIGNED
  MAINTENANCE
  INACTIVE
}

model Vehicle {
  id              String        @id @default(uuid())
  plateNumber     String        @unique
  type            VehicleType
  brand           String?
  model           String?
  year            Int?
  capacity        Decimal?       // in tons
  status          VehicleStatus @default(AVAILABLE)
  
  // Owner Information
  vendorId        String
  vendor          Vendor        @relation(fields: [vendorId], references: [id])
  
  // Documentation
  licenseExpiry   DateTime?
  insuranceExpiry DateTime?
  lastMaintenance DateTime?
  
  // GPS Device
  gpsDeviceId     String?       @unique
  gpsActive       Boolean       @default(false)
  
  isActive        Boolean       @default(true)
  notes           String?
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@index([plateNumber])
  @@index([vendorId])
  @@index([status])
  @@map("vehicles")
}

// ============================================
// INVOICES & BILLING
// ============================================

enum InvoiceType {
  SALES_INVOICE
  PURCHASE_INVOICE
  CREDIT_NOTE
  DEBIT_NOTE
}

enum InvoiceStatus {
  DRAFT
  SENT
  PARTIALLY_PAID
  PAID
  OVERDUE
  CANCELLED
}

model Invoice {
  id              String        @id @default(uuid())
  invoiceNumber   String        @unique
  type            InvoiceType
  status          InvoiceStatus @default(DRAFT)
  date            DateTime
  dueDate         DateTime?
  
  // Customer
  customerId      String
  customer        Customer      @relation(fields: [customerId], references: [id])
  
  // Amounts
  subtotal        Decimal      
  taxAmount       Decimal       @default(0)
  discountAmount  Decimal       @default(0)
  total           Decimal      
  paidAmount      Decimal       @default(0)
  remainingAmount Decimal      
  
  // Details
  items           InvoiceItem[]
  payments        Payment[]
  
  // Reference
  referenceType   String?       // TENDER, WORK_ORDER, CONTRACT
  referenceId     String?
  
  notes           String?
  terms           String?
  
  // Audit
  createdById     String
  createdBy       User          @relation("CreatedBy", fields: [createdById], references: [id])
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@index([invoiceNumber])
  @@index([customerId])
  @@index([status])
  @@index([date])
  @@map("invoices")
}

model InvoiceItem {
  id              String   @id @default(uuid())
  invoiceId       String
  invoice         Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  description     String
  descriptionAr   String?
  quantity        Decimal 
  unitPrice       Decimal 
  taxRate         Decimal  @default(0)  // Tax percentage
  discountRate    Decimal  @default(0)
  total           Decimal 
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([invoiceId])
  @@map("invoice_items")
}

// ============================================
// BILLS (VENDOR INVOICES)
// ============================================

enum BillStatus {
  DRAFT
  APPROVED
  PARTIALLY_PAID
  PAID
  CANCELLED
}

model Bill {
  id              String     @id @default(uuid())
  billNumber      String     @unique
  status          BillStatus @default(DRAFT)
  date            DateTime
  dueDate         DateTime?
  
  // Vendor
  vendorId        String
  vendor          Vendor     @relation(fields: [vendorId], references: [id])
  
  // Amounts
  subtotal        Decimal   
  taxAmount       Decimal    @default(0)
  total           Decimal   
  paidAmount      Decimal    @default(0)
  remainingAmount Decimal   
  
  // Details
  items           BillItem[]
  payments        Payment[]
  
  // Reference
  referenceType   String?    // WORK_ORDER, PURCHASE_ORDER
  referenceId     String?
  
  notes           String?
  
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  
  @@index([billNumber])
  @@index([vendorId])
  @@index([status])
  @@map("bills")
}

model BillItem {
  id              String   @id @default(uuid())
  billId          String
  bill            Bill     @relation(fields: [billId], references: [id], onDelete: Cascade)
  
  description     String
  descriptionAr   String?
  quantity        Decimal 
  unitPrice       Decimal 
  taxRate         Decimal  @default(0)
  total           Decimal 
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([billId])
  @@map("bill_items")
}

// ============================================
// PAYMENTS
// ============================================

enum PaymentMethod {
  CASH
  BANK_TRANSFER
  CHECK
  CREDIT_CARD
  MOBILE_WALLET
}

enum PaymentType {
  RECEIVED  // From customer
  SENT      // To vendor
}

model Payment {
  id              String        @id @default(uuid())
  paymentNumber   String        @unique
  type            PaymentType
  method          PaymentMethod
  date            DateTime
  amount          Decimal      
  
  // Customer Payment
  customerId      String?
  customer        Customer?     @relation(fields: [customerId], references: [id])
  invoiceId       String?
  invoice         Invoice?      @relation(fields: [invoiceId], references: [id])
  
  // Vendor Payment
  vendorId        String?
  vendor          Vendor?       @relation(fields: [vendorId], references: [id])
  billId          String?
  bill            Bill?         @relation(fields: [billId], references: [id])
  
  // Bank Details
  bankName        String?
  accountNumber   String?
  checkNumber     String?
  transactionRef  String?
  
  notes           String?
  
  // Audit
  createdById     String
  createdBy       User          @relation("CreatedBy", fields: [createdById], references: [id])
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@index([paymentNumber])
  @@index([customerId])
  @@index([vendorId])
  @@index([date])
  @@map("payments")
}

// ============================================
// COST CENTERS
// ============================================

model CostCenter {
  id          String   @id @default(uuid())
  code        String   @unique
  name        String
  nameAr      String
  description String?
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("cost_centers")
}

// ============================================
// TENDERS (مناقصات)
// ============================================

enum TenderStatus {
  DRAFT                 // مسودة
  PUBLISHED             // منشورة
  DOCUMENT_PURCHASE     // مرحلة شراء كراسة الشروط
  SUBMISSION_OPEN       // مفتوحة للتقديم
  SUBMISSION_CLOSED     // مغلقة للتقديم
  UNDER_EVALUATION      // تحت التقييم
  AWARDED               // تم الإرساء
  WORK_IN_PROGRESS      // جاري التنفيذ
  COMPLETED             // مكتملة
  CANCELLED             // ملغاة
}

enum TenderType {
  PUBLIC            // مناقصة عامة
  LIMITED           // مناقصة محدودة
  DIRECT            // أمر مباشر
  FRAMEWORK         // اتفاقية إطارية
}

enum BidStatus {
  DRAFT             // مسودة
  SUBMITTED         // مقدم
  UNDER_REVIEW      // تحت المراجعة
  QUALIFIED         // مؤهل
  DISQUALIFIED      // غير مؤهل
  WINNER            // فائز
  REJECTED          // مرفوض
}

enum DocumentPurchaseStatus {
  PENDING           // في الانتظار
  PAID              // مدفوعة
  DOWNLOADED        // تم التحميل
  EXPIRED           // منتهية
}

model Tender {
  id                    String        @id @default(uuid())
  tenderNumber          String        @unique
  referenceNumber       String?       // رقم مرجعي خارجي
  type                  TenderType
  status                TenderStatus  @default(DRAFT)
  
  // Basic Information
  title                 String
  titleAr               String
  description           String        @db.Text
  descriptionAr         String        @db.Text
  category              String        // نوع النشاط (نقل، تخزين، تخليص جمركي، إلخ)
  
  // Financial Details
  estimatedValue        Decimal      
  currency              String        @default("EGP")
  documentPrice         Decimal       @default(0)  // سعر كراسة الشروط
  bidBond               Decimal       @default(0)  // التأمين الابتدائي
  performanceBond       Decimal       @default(0)  // التأمين النهائي
  
  // Important Dates
  publishDate           DateTime?                                       // تاريخ النشر
  documentSaleStart     DateTime?                                       // بداية بيع كراسة الشروط
  documentSaleEnd       DateTime?                                       // نهاية بيع كراسة الشروط
  submissionDeadline    DateTime?                                       // الموعد النهائي للتقديم
  openingDate           DateTime?                                       // تاريخ فتح المظاريف
  awardDate             DateTime?                                       // تاريخ الإرساء
  workStartDate         DateTime?                                       // تاريخ بداية العمل
  workEndDate           DateTime?                                       // تاريخ انتهاء العمل
  
  // Terms and Conditions
  requirements          Json?                                          // متطلبات التأهيل
  terms                 String?       @db.Text                          // الشروط والأحكام
  termsAr               String?       @db.Text
  scope                 String?       @db.Text                          // نطاق العمل
  scopeAr               String?       @db.Text
  
  // Contact Information
  contactPerson         String?
  contactPhone          String?
  contactEmail          String?
  
  // Relations
  documents             TenderDocument[]
  documentPurchases     DocumentPurchase[]
  bids                  Bid[]
  evaluations           TenderEvaluation[]
  workOrders            WorkOrder[]
  items                 TenderItem[]
  milestones            TenderMilestone[]
  
  // Audit
  createdById           String
  createdBy             User          @relation("TenderCreatedBy", fields: [createdById], references: [id])
  
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt
  
  @@index([tenderNumber])
  @@index([status])
  @@index([type])
  @@index([publishDate])
  @@map("tenders")
}

// بنود المناقصة
model TenderItem {
  id              String   @id @default(uuid())
  tenderId        String
  tender          Tender   @relation(fields: [tenderId], references: [id], onDelete: Cascade)
  
  itemNumber      String   // رقم البند
  description     String   @db.Text
  descriptionAr   String   @db.Text
  quantity        Decimal 
  unit            String   // الوحدة (كم، طن، حاوية، إلخ)
  unitAr          String
  estimatedPrice  Decimal 
  specifications  Json?    // المواصفات التفصيلية
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([tenderId])
  @@map("tender_items")
}

// مراحل تنفيذ المناقصة
model TenderMilestone {
  id              String    @id @default(uuid())
  tenderId        String
  tender          Tender    @relation(fields: [tenderId], references: [id], onDelete: Cascade)
  
  milestoneNumber Int
  title           String
  titleAr         String
  description     String?   @db.Text
  descriptionAr   String?   @db.Text
  percentage      Decimal    // نسبة الإنجاز
  amount          Decimal  
  dueDate         DateTime?
  completedDate   DateTime?
  status          String    @default("PENDING") // PENDING, IN_PROGRESS, COMPLETED, DELAYED
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([tenderId])
  @@map("tender_milestones")
}

// مستندات المناقصة
model TenderDocument {
  id              String   @id @default(uuid())
  tenderId        String
  tender          Tender   @relation(fields: [tenderId], references: [id], onDelete: Cascade)
  
  title           String
  titleAr         String
  type            String   // SPECIFICATIONS, TERMS, TECHNICAL, FINANCIAL, OTHER
  fileName        String
  fileUrl         String
  fileSize        Int?
  version         String   @default("1.0")
  isRequired      Boolean  @default(false)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([tenderId])
  @@map("tender_documents")
}

// شراء كراسة الشروط
model DocumentPurchase {
  id              String                  @id @default(uuid())
  purchaseNumber  String                  @unique
  tenderId        String
  tender          Tender                  @relation(fields: [tenderId], references: [id])
  vendorId        String
  vendor          Vendor                  @relation(fields: [vendorId], references: [id])
  
  status          DocumentPurchaseStatus  @default(PENDING)
  amount          Decimal                
  paymentMethod   String?
  paymentRef      String?
  purchaseDate    DateTime                @default(now())
  downloadDate    DateTime?
  expiryDate      DateTime?
  
  notes           String?
  
  createdAt       DateTime                @default(now())
  updatedAt       DateTime                @updatedAt
  
  @@index([purchaseNumber])
  @@index([tenderId])
  @@index([vendorId])
  @@map("document_purchases")
}

// العروض المقدمة
model Bid {
  id              String    @id @default(uuid())
  bidNumber       String    @unique
  tenderId        String
  tender          Tender    @relation(fields: [tenderId], references: [id])
  vendorId        String
  vendor          Vendor    @relation(fields: [vendorId], references: [id])
  
  status          BidStatus @default(DRAFT)
  
  // Financial Offer
  totalAmount     Decimal  
  currency        String    @default("EGP")
  validityPeriod  Int?      // مدة سريان العرض بالأيام
  
  // Technical Details
  technicalScore  Decimal?   // الدرجة الفنية
  financialScore  Decimal?   // الدرجة المالية
  totalScore      Decimal?   // الدرجة الإجمالية
  
  // Submission Details
  submittedDate   DateTime?
  openedDate      DateTime?
  
  // Documents
  documents       BidDocument[]
  items           BidItem[]
  
  // Notes and Comments
  notes           String?   @db.Text
  evaluationNotes String?   @db.Text
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([bidNumber])
  @@index([tenderId])
  @@index([vendorId])
  @@index([status])
  @@map("bids")
}

// بنود العرض
model BidItem {
  id              String   @id @default(uuid())
  bidId           String
  bid             Bid      @relation(fields: [bidId], references: [id], onDelete: Cascade)
  
  itemNumber      String
  description     String   @db.Text
  quantity        Decimal 
  unitPrice       Decimal 
  totalPrice      Decimal 
  notes           String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([bidId])
  @@map("bid_items")
}

// مستندات العرض
model BidDocument {
  id              String   @id @default(uuid())
  bidId           String
  bid             Bid      @relation(fields: [bidId], references: [id], onDelete: Cascade)
  
  title           String
  type            String   // TECHNICAL, FINANCIAL, LEGAL, CERTIFICATES, OTHER
  fileName        String
  fileUrl         String
  fileSize        Int?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([bidId])
  @@map("bid_documents")
}

// تقييم المناقصات
model TenderEvaluation {
  id              String   @id @default(uuid())
  tenderId        String
  tender          Tender   @relation(fields: [tenderId], references: [id])
  
  evaluationType  String   // TECHNICAL, FINANCIAL, COMBINED
  criteria        Json     // معايير التقييم
  weights         Json     // الأوزان النسبية
  
  evaluatedById   String
  evaluatedBy     User     @relation("TenderEvaluatedBy", fields: [evaluatedById], references: [id])
  evaluationDate  DateTime @default(now())
  
  report          String?  @db.Text
  reportAr        String?  @db.Text
  recommendation  String?  @db.Text
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([tenderId])
  @@map("tender_evaluations")
}

// أوامر العمل (مرتبطة بالمناقصات)
model WorkOrder {
  id              String   @id @default(uuid())
  orderNumber     String   @unique
  
  tenderId        String?
  tender          Tender?  @relation(fields: [tenderId], references: [id])
  
  customerId      String
  customer        Customer @relation(fields: [customerId], references: [id])
  
  vendorId        String?
  vendor          Vendor?  @relation(fields: [vendorId], references: [id])
  
  status          String   @default("PENDING") // PENDING, ASSIGNED, IN_PROGRESS, COMPLETED, CANCELLED
  
  // Details
  description     String   @db.Text
  descriptionAr   String   @db.Text
  startDate       DateTime?
  endDate         DateTime?
  actualStartDate DateTime?
  actualEndDate   DateTime?
  
  // Financial
  totalAmount     Decimal 
  paidAmount      Decimal  @default(0)
  
  notes           String?  @db.Text
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([orderNumber])
  @@index([tenderId])
  @@index([customerId])
  @@index([vendorId])
  @@map("work_orders")
}
